# Express-Hawk (Middleware)

This module provides a [Hawk](https://github.com/hueniverse/hawk)
authentication middleware for [Express](https://github.com/expressjs/express) v4.x applications. 


## Installation

To use the package, you'll need to add the dependency:

    npm install --save dreyer/express-hawk
    
To run the tests if you're doing development on the library:

	npm test

## Usage

In order to use Hawk within your application, you'll need to use it as
a middleware:

```javascript
const express = require('express')
const hawk = require('express-hawk')

const app = express()

const port = 8081
const host = 'localhost'

function getCredentials(id) {
    let user = {
        id: '1',
        name: 'John Smith',
        email: 'j.smith@example.org'
    }

    let credentials = {
        id: id,
        key: 'key',
        algorithm: 'sha256',
        user: user
    }

    return credentials
}

const authentication = hawk.getMiddleware({
    getSession(id, cb) {
        console.log('getSession: id=' + id)

        // A function which pass to the cb the key and algorithm for the
        // given token id. First argument of the callback is a potential
        // error.

        let credentials = getCredentials(id)

        cb(null, credentials)
    },
    setSession(req, res, credentials, cb) {
        console.log('setSession: credentials=', credentials)

        // A function which stores a session for the given id and key.
        // Argument returned is a potential error.
        req.credentials = credentials

        cb(null)
    }
});

app.use((req, res, next) => {
    console.log(`request: ${req.method} ${req.url}`)
    next()
})

app.get('/', (req, res) => res.send('hello world'))
app.get('/secured', authentication)

app.listen(port, () => console.log(`app.listen: http://${host}:${port}\n`))
```

The middleware only takes one argument, which is a `config` object containing
parameters defined below:

| Name | Type | Description |
| ---- | ---- | ----------- |
| `options` | Object | Additional options to pass to the underlying Hawk functions for `hawk.uri.authenticate` and `hawk.server.authenticate`. Also helpful for overriding the `options.host` and `options.port`. |
| `getSession` | Function | Define how to find the credentials from the identifier of the session and a callback argument: `getSession(id, callback)`. The `callback` is executed when the search operation has finished. The signature for the callback is `callback(err, credentials)`. In the event that the record doesn't exist, you can call `callback(null, null)`. |
| `setSession` | Function | Define how to store a new session credentials for the duration of the request. `setSession(req, res, credentials, callback)`. The `callback` is executed when storage has finished using the signature `callback(err, credentials, callback)`. |
| `sendError` | Function | Parse errors generated by the library. In the format: `sendError(res, statusCode, reasonPhrase, payload)` |

    
## Contributing

1. Fork it!
2. Create your feature branch: `git checkout -b my-new-feature`
3. Commit your changes: `git commit -am 'Add some feature'`
4. Push to the branch: `git push origin my-new-feature`
5. Submit a pull request :D

## History

See [CHANGELOG.md](./CHANGELOG.md)

## Credits

Thanks to the Mozilla team for the idea: [mozilla-services/express-hawkauth](https://github.com/mozilla-services/express-hawkauth)

## License

MIT